---
description: "Secrets & auth hygiene; align with agent security posture. Blocks creation of .env files except root .env"
globs: "*.ts,*.tsx,*.js,*.jsx,*.mjs,*.cjs,*.env*,*.md"
alwaysApply: false
priority: 60
---

# Security & Secrets Management (RFC-2119 MANDATORY)

**Purpose**: Prevent secrets exposure and enforce single .env file policy
**Authority**: Blocks creation of .env files except root .env
**Status**: MANDATORY - Enforced via validation scripts

---

## 1. Environment Variable Policy (STRICT)

### ✅ ALLOWED: Root .env Only

**ONLY this file is allowed**:
```
C:\AI-BOS\mythic\.env
```

**Why**:
- Single source of truth for all environment variables
- Easier to manage and secure
- Prevents configuration drift
- Next.js apps automatically load root .env

### ❌ FORBIDDEN: All Other .env Files

**BLOCKED**:
- `apps/**/.env*` - App-specific .env files
- `packages/**/.env*` - Package-specific .env files
- `.env.local`, `.env.development`, `.env.production` - Environment-specific files
- Any `.env*` file outside root

**Enforcement**:
- Pre-commit hook blocks commits with .env files outside root
- Cursor AI blocks creation of .env files outside root
- Validation script checks for violations

---

## 2. Environment Variable Loading

### Next.js Apps (Automatic)

**No dotenv import needed** - Next.js automatically loads root `.env`:

```typescript
// ✅ CORRECT - Next.js auto-loads root .env
const dbUrl = process.env.DATABASE_URL

// ❌ INCORRECT - Don't import dotenv in Next.js apps
import { config } from 'dotenv'
config()
```

### Scripts (Explicit Root Path)

**Scripts MUST load from root .env explicitly**:

```typescript
// ✅ CORRECT - Load from root .env
import { config } from 'dotenv'
import { resolve } from 'path'

const rootEnvPath = resolve(process.cwd(), '.env')
config({ path: rootEnvPath })

// ❌ INCORRECT - Don't use default config()
import { config } from 'dotenv'
config() // This might load wrong .env file
```

### Drizzle Configs

**Drizzle configs MUST load from root .env**:

```typescript
// ✅ CORRECT
import { config } from 'dotenv'
import { resolve } from 'path'

const rootEnvPath = resolve(process.cwd(), '.env')
config({ path: rootEnvPath })

// ❌ INCORRECT - Don't check for app-specific .env files
const appEnv = join(cwd, '.env')
if (existsSync(appEnv)) {
  config({ path: appEnv }) // ❌ FORBIDDEN
}
```

---

## 3. Cursor AI Behavior

### When Creating Files

**MUST NOT**:
- ❌ Create `.env` files in `apps/` directories
- ❌ Create `.env` files in `packages/` directories
- ❌ Create `.env.local`, `.env.development`, etc.
- ❌ Suggest app-specific .env files
- ❌ Import dotenv in Next.js app code

**MUST**:
- ✅ Use `process.env` directly in Next.js apps (auto-loads root .env)
- ✅ Load root .env explicitly in scripts with `config({ path: resolve(process.cwd(), '.env') })`
- ✅ Reference root `.env` file location: `C:\AI-BOS\mythic\.env`

---

## 4. Validation & Enforcement

### Pre-Commit Hook

```bash
# .husky/pre-commit
# Check for .env files outside root
ENV_FILES=$(git diff --cached --name-only | grep -E '\.env' | grep -vE '^\.env$' || true)

if [ -n "$ENV_FILES" ]; then
  echo "❌ Error: Cannot commit .env files outside root directory"
  echo "Only C:\\AI-BOS\\mythic\\.env is allowed"
  echo "Found files:"
  echo "$ENV_FILES"
  exit 1
fi
```

### Validation Script

```typescript
// scripts/validate-env-files.ts
function validateEnvFiles() {
  const envFiles = glob.sync('**/.env*', {
    ignore: ['node_modules/**', '.git/**', '.env'] // Allow root .env
  })

  if (envFiles.length > 0) {
    throw new Error(`Found .env files outside root: ${envFiles.join(', ')}`)
  }
}
```

---

## 5. Migration Guide

### If You Have Existing .env Files

1. **Merge all .env files into root `.env`**
2. **Delete app/package-specific .env files**
3. **Update scripts to load from root .env**
4. **Test that everything still works**

### Example Migration

```bash
# Before (WRONG)
apps/boardroom/.env
apps/StratonHub/.env.local

# After (CORRECT)
.env  # Root only, contains all variables
```

---

## 6. Best Practices

### Environment Variable Organization

**In root `.env` file**:

```env
# Database (used by all apps)
DATABASE_URL=postgresql://...

# Next.js Public Variables
NEXT_PUBLIC_APP_URL=http://localhost:3000

# App-Specific (prefix with app name if needed)
BOARDROOM_API_KEY=...
STRATONHUB_API_KEY=...

# Shared
NODE_ENV=development
LOG_LEVEL=debug
```

### Accessing Variables

**In Next.js Apps**:
```typescript
// ✅ Direct access (auto-loaded from root .env)
const dbUrl = process.env.DATABASE_URL
```

**In Scripts**:
```typescript
// ✅ Explicit root .env loading
import { config } from 'dotenv'
import { resolve } from 'path'
config({ path: resolve(process.cwd(), '.env') })
const dbUrl = process.env.DATABASE_URL
```

---

## 7. Security Considerations

### Secrets Management

- ✅ **Root .env is gitignored** (never commit)
- ✅ **Use `.env.example`** for documentation (no real secrets)
- ✅ **Rotate secrets** if accidentally committed
- ✅ **Use environment-specific secrets** in production (Vercel, etc.)

### Validation

- ✅ **Validate env vars** at startup (Zod schemas in apps)
- ✅ **Fail fast** if required vars missing
- ✅ **Type-safe access** via validated env objects

---

## 8. Troubleshooting

### Issue: "Environment variable not found"

**Cause**: Variable not in root `.env` file
**Solution**: Add to `C:\AI-BOS\mythic\.env`

### Issue: "Script can't find .env"

**Cause**: Script not loading from root
**Solution**: Use `config({ path: resolve(process.cwd(), '.env') })`

### Issue: "Next.js app can't find env var"

**Cause**: Variable not prefixed with `NEXT_PUBLIC_` for client-side
**Solution**: Use `NEXT_PUBLIC_*` prefix or access server-side only

---

**Status**: MANDATORY - Enforced via pre-commit hooks
**Version**: 1.0.0
**Created**: 2026-01-13
**Authority**: Security & Configuration Governance Policy
