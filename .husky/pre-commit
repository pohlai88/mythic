#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Validate rule configurations first
echo "üîç Validating Cursor rule configurations..."
pnpm validate:rules:strict

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Rule validation failed!"
  echo "Fix issues with: pnpm validate:rules:fix"
  echo ""
  exit 1
fi

echo "‚úÖ Rule validation passed"
echo ""

# Auto-fix documentation naming before validation
echo "üîß Auto-fixing documentation naming..."
pnpm fix:docs:naming || true

# Validate documentation naming
echo "üìã Validating documentation naming..."
pnpm validate:docs:naming

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Documentation naming validation failed!"
  echo "Run: pnpm fix:docs:naming to auto-fix issues"
  echo ""
  exit 1
fi

echo "‚úÖ Documentation naming validation passed"
echo ""

# Run lint-staged for staged files
npx lint-staged

# Check for markdown files in root (except allowed ones)
ROOT_MD_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E '^[^/]+\.md$' | grep -vE '^(README|QUICK_START|QUICK_REFERENCE)\.md$' || true)

if [ -n "$ROOT_MD_FILES" ]; then
  echo "‚ùå Error: Cannot commit markdown files to root directory"
  echo "Allowed files: README.md, QUICK_START.md, QUICK_REFERENCE.md"
  echo "Found files:"
  echo "$ROOT_MD_FILES"
  echo ""
  echo "Please move these files to the appropriate docs/ subdirectory:"
  echo "  - Migration docs ‚Üí docs/migrations/"
  echo "  - Guides ‚Üí docs/guides/"
  echo "  - API docs ‚Üí docs/api/"
  echo "  - Reference ‚Üí docs/reference/"
  echo "  - Changelog ‚Üí docs/changelog/"
  echo ""
  echo "Or run: pnpm organize-docs"
  exit 1
fi
