#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Validate rule configurations first
echo "üîç Validating Cursor rule configurations..."
pnpm validate:rules:strict

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Rule validation failed!"
  echo "Fix issues with: pnpm validate:rules:fix"
  echo ""
  exit 1
fi

echo "‚úÖ Rule validation passed"
echo ""

# Validate verbatim config files
echo "üîç Validating verbatim config files..."
pnpm validate:verbatim

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Verbatim validation failed!"
  echo "Fix config files to match documented templates in docs/architecture/ELITE_VERBATIM_STRATEGY.md"
  echo ""
  exit 1
fi

echo "‚úÖ Verbatim validation passed"
echo ""

# Auto-fix documentation naming before validation
echo "üîß Auto-fixing documentation naming..."
pnpm fix:docs:naming || true

# Validate documentation naming
echo "üìã Validating documentation naming..."
pnpm validate:docs:naming

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Documentation naming validation failed!"
  echo "Run: pnpm fix:docs:naming to auto-fix issues"
  echo ""
  exit 1
fi

echo "‚úÖ Documentation naming validation passed"
echo ""

# Validate tech debt patterns
echo "üîç Validating tech debt patterns..."
pnpm validate:tech-debt

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Tech debt validation failed!"
  echo "Fix issues before committing"
  echo ""
  exit 1
fi

echo "‚úÖ Tech debt validation passed"
echo ""

# Validate imports (path aliases)
echo "üîç Validating imports..."
pnpm validate:imports

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Import validation failed!"
  echo "Fix relative imports before committing"
  echo "Run: pnpm validate:imports to see violations"
  echo ""
  exit 1
fi

echo "‚úÖ Import validation passed"
echo ""

# Validate design system sealing
echo "üîí Validating design system sealing..."
pnpm validate:design-system-sealed

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Design system sealing validation failed!"
  echo "The design-system package is SEALED and cannot be modified."
  echo "See: packages/design-system/VALIDATION_REPORT.md"
  echo ""
  exit 1
fi

echo "‚úÖ Design system sealing validation passed"
echo ""

# Validate intelligence CSS classes
echo "üîç Validating intelligence CSS classes..."
pnpm validate:intelligence-classes

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Intelligence CSS classes validation failed!"
  echo "All intelligence CSS classes MUST be defined in axis-base.css"
  echo "See: packages/design-system/DESIGN_SYSTEM_TOKEN_CONSTITUTION.md"
  echo ""
  exit 1
fi

echo "‚úÖ Intelligence CSS classes validation passed"
echo ""

# Validate CSS file locking
echo "üîí Validating CSS file locking..."
pnpm validate:css-files

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå CSS file locking validation failed!"
  echo "System-generated CSS files must be built via build:css and tokens:propagate-version"
  echo ""
  exit 1
fi

echo "‚úÖ CSS file locking validation passed"
echo ""

# Code formatting is handled by individual app/package lint scripts via turbo

# Validate README files (README-only policy)
echo "üìã Validating README files..."
cd apps/docs && pnpm readme:validate-all

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå README validation failed!"
  echo "Fix README files to match standard template"
  echo ""
  exit 1
fi

echo "‚úÖ README validation passed"
echo ""

# Check README-only policy
cd apps/docs && pnpm readme:check-only

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå README-only policy violation!"
  echo "Only README.md files are allowed in apps/ and packages/"
  echo "Move content to README.md, then delete non-README .md files"
  echo ""
  exit 1
fi

echo "‚úÖ README-only policy: Compliant"
echo ""

# Check for markdown files in root (except allowed ones)
ROOT_MD_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E '^[^/]+\.md$' | grep -vE '^README\.md$' || true)

if [ -n "$ROOT_MD_FILES" ]; then
  echo "‚ùå Error: Cannot commit markdown files to root directory"
  echo "Allowed files: README.md only"
  echo "Found files:"
  echo "$ROOT_MD_FILES"
  echo ""
  echo "Please move these files to the appropriate docs/ subdirectory:"
  echo "  - Migration docs ‚Üí docs/migrations/"
  echo "  - Guides ‚Üí docs/guides/"
  echo "  - API docs ‚Üí docs/api/"
  echo "  - Reference ‚Üí docs/reference/"
  echo "  - Changelog ‚Üí docs/changelog/"
  echo ""
  echo "Or run: pnpm organize-docs"
  exit 1
fi

# Validate environment file policy (ONLY root .env is allowed)
echo "üîç Validating environment file policy..."
pnpm validate:env-files

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Environment file validation failed!"
  echo "Only C:\\AI-BOS\\mythic\\.env is allowed"
  echo "See: .cursor/rules/060_security-secrets.mdc"
  echo ""
  exit 1
fi

echo "‚úÖ Environment file policy: Compliant"
echo ""
